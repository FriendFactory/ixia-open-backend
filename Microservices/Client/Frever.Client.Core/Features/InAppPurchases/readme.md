# In-App purchases notes

## Basic terms and entities

Check git history for previous varians

- **In-app Product (Product)** - entity that may be offered to User.
  Includes one-time purchases and subscriptions.

- **In-App Product Details (Details)**. Internal set of values within In-App Product.
  May include Hard Currency Amount.

- **Token**. Consumable currency used for content generation. Referred as hard currency at application backend

- **Subscription**. Renewable monthly subscription to application services. Includes monthly refilled a number of tokens (hard currency).

- **Free plan**. Special in-app product (has `IsSubscription=true and IsFreeProduct=true`) determines the number of tokens refilled up to daily if there is no active subscription.

## What User purchases?

User might purchase subscription or number of tokens.

## How it should work

### from user perspective:

User have three pools of tokens: daily, subscription and permanent tokens.

- Daily tokens refilled daily with fixed amount (possible depending of current subscription plan)
- Subscription token refilled monthly at the start of subscription if subscription still active
- Permanent tokens are purchased via in-app purchase. They are not refilled.

Refilling tokens means that in the moment of refilling (start of day, start of subscription period) the corresponding number of tokens will be corrected to target value, either added or substracted.

### from the backend perspective:

- Hard currency changes recorded as asset store transaction as before.
- Refillings recorded as transactions too.
- Refilling transactions are generated by recurring job at the start of the day.
- Expenses (consuming tokens) recorded normally as single transaction, without separation to daily/subscription/permanent expenses.
- Calculation of amount to refill is performed in the moment of refilling.
- On refilling token we always refill full daily/monthly amount.
  This way the system always knows an amount of daily/monthly token user have.
  To compensate unused tokens system record expence with special transaction type `DailyTokenBurnout`/`MonthlyTokenBurnout`.
- There might be special case with two active subscriptions if user changes active subscription plan. In this case system burns out remaining monthly tokens and refill total old + new subscription tokens. But next month only new subscription would be refilled.
